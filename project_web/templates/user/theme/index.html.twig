{% extends 'theme/base.html.twig' %}

{% block title %}Theme Management â€” NEXA{% endblock %}

{% block body %}

<!-- ================= HEADER ================= -->
<section class="page-header">
    <div class="page-header-top">

        <!-- TITLE -->
        <div class="page-title">
            <h1>Theme Management</h1>
            <p>Manage themes, questions and priorities</p>
        </div>

        <!-- ACTIONS -->
        <div class="page-actions">

            <!-- ğŸ” SEARCH -->
            <form method="get"
                  action="{{ path('app_theme_index') }}"
                  class="search-form"
                  onsubmit="return false;">
                <div class="search-wrapper">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input
                        type="text"
                        name="q"
                        value="{{ search ?? '' }}"
                        placeholder="Search theme..."
                        class="search-input"
                        autocomplete="off"
                    >
                </div>
            </form>

        </div>
    </div>
</section>

<!-- ================= KPI ================= -->
<section class="kpi-grid">
    <div class="kpi-card">
        <span>Total themes</span>
        <strong>{{ themes|length }}</strong>
    </div>

    <div class="kpi-card">
        <span>Active themes</span>
        <strong>{{ themes|filter(t => t.actif)|length }}</strong>
    </div>
</section>

<!-- ================= THEMES ================= -->
<section class="themes-grid" id="themes-container">

{% for theme in themes %}
    <article class="theme-card">

        <div class="theme-card-header">
            <div class="theme-left">
                <div class="theme-icon"
                     style="--theme-accent: {{ theme.couleur ?: '#6366f1' }}">
                    {% if theme.icone and (theme.icone starts with 'fa') %}
                        <i class="{{ theme.icone }}"></i>
                    {% else %}
                        {{ theme.icone|default('')|raw }}
                    {% endif %}
                </div>

                <div class="theme-info">
                    <h3>{{ theme.nom }}</h3>
                    <span>{{ theme.createdAt|date('d M Y') }}</span>
                </div>
            </div>

            <span class="theme-status {{ theme.actif ? 'active' : 'inactive' }}">
                {{ theme.actif ? 'Active' : 'Inactive' }}
            </span>
        </div>

        <div class="theme-card-body">
            <p>{{ theme.intention ?? 'No description_q provided.' }}</p>
        </div>

        <div class="theme-card-footer">
            <div class="theme-stats">
                <span>
                    <i class="fa-solid fa-circle-question"></i>
                    {{ theme.questions|length }}
                </span>
                <span class="priority-chip">
                    <i class="fa-solid fa-flag"></i>
                    <em>P{{ theme.priorite ?? 2 }}</em>
                    <small class="priority-stars" aria-label="PrioritÃ© {{ theme.priorite ?? 2 }} sur 3">
                        {% for i in 1..3 %}
                            <i class="fa-star {{ i <= (theme.priorite ?? 2) ? 'fa-solid' : 'fa-regular' }}"></i>
                        {% endfor %}
                    </small>
                </span>
            </div>

            <!-- âœ… ACTIONS : VIEW ONLY -->
            <div class="theme-actions">
    <a href="{{ path('app_theme_answer', { id: theme.idT }) }}">
        <i class="fa-solid fa-eye"></i>
    </a>
</div>

        </div>

    </article>

{% else %}
    <div class="empty-state">
        No themes found.
    </div>
{% endfor %}

</section>

<!-- ================= JS : SEARCH INSTANT ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const input = document.querySelector('.search-input');
    const container = document.getElementById('themes-container');
    if (!input) return;

    let timeout = null;

    input.addEventListener('input', () => {
        clearTimeout(timeout);

        timeout = setTimeout(() => {
            fetch(`{{ path('app_theme_index') }}?q=` + encodeURIComponent(input.value), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.text())
            .then(html => {
                container.innerHTML = html;
            });
        }, 250);
    });
});
</script>
<div id="chatbot-bubble">ğŸ¤–</div>

<div id="chatbot-box" class="chatbot hidden">
  <div class="chat-header">
    Theme Assistant
    <span id="chat-close">âœ•</span>
  </div>

  <div id="chat-messages" class="chat-messages">
    <div class="bot">
      Ù…Ø±Ø­Ø¨Ø§ ğŸ‘‹  
      Ù†Ø¬Ù… Ù†Ø¹Ø§ÙˆÙ†Ùƒ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ ØªØ·ÙˆÙŠØ± Ø§Ù„Ù€ themes.
    </div>
  </div>

  <input
    type="text"
    id="chat-input"
    placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ..."
  >
</div>
<script>
const bubble = document.getElementById('chatbot-bubble');
const box = document.getElementById('chatbot-box');
const closeBtn = document.getElementById('chat-close');
const input = document.getElementById('chat-input');
const messages = document.getElementById('chat-messages');

bubble.onclick = () => box.classList.toggle('hidden');
closeBtn.onclick = () => box.classList.add('hidden');

input.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter' && input.value.trim() !== '') {

    const msg = input.value;
    messages.innerHTML += `<div class="user">${msg}</div>`;
    input.value = '';

    const res = await fetch('{{ path("app_theme_assistant") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: msg })
    });

    const data = await res.json();
    messages.innerHTML += `<div class="bot">${data.reply}</div>`;
    messages.scrollTop = messages.scrollHeight;
  }
});
</script>

{% endblock %}

