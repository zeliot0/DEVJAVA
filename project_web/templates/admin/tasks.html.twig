{% extends 'admin/base.html.twig' %}

{% block admin_page_title %}Mod√©ration & Analytics{% endblock %}
{% block admin_page_hint %}Gestion proactive et statistiques avanc√©es de la plateforme{% endblock %}

{% block admin_content %}
    <!-- üìä Analytics Section -->
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 24px; margin-bottom: 40px; min-height: 350px;">
        <div class="panel" style="display: flex; flex-direction: column;">
            <div class="panel-title" style="margin-bottom: 15px;"><i class="fa-solid fa-chart-line" style="color: var(--primary);"></i> Flux Mensuel</div>
            <div style="flex: 1; position: relative; width: 100%; height: 250px;">
                <canvas id="chartMonths"></canvas>
            </div>
        </div>

        <div class="panel" style="display: flex; flex-direction: column;">
            <div class="panel-title" style="margin-bottom: 15px;"><i class="fa-solid fa-pie-chart" style="color: var(--good);"></i> Statuts</div>
            <div style="flex: 1; position: relative; width: 100%; height: 250px;">
                <canvas id="chartStatus"></canvas>
            </div>
        </div>

        <div class="panel" style="display: flex; flex-direction: column;">
            <div class="panel-title" style="margin-bottom: 15px;"><i class="fa-solid fa-fire" style="color: var(--bad);"></i> Priorit√©s</div>
            <div style="flex: 1; position: relative; width: 100%; height: 250px;">
                <canvas id="chartPriority"></canvas>
            </div>
        </div>
    </div>

    <!-- üõ†Ô∏è Moderation Table -->
    <div class="panel">
        <div class="panel-title" style="margin-bottom: 25px;">
            <i class="fa-solid fa-hammer" style="color: var(--bad);"></i> Liste de Mod√©ration Active
        </div>
        
        <div style="overflow-x: auto;">
            <table class="adm-table" style="width: 100%;">
                <thead>
                    <tr style="text-align: left; color: var(--muted); font-size: 0.8rem; text-transform: uppercase;">
                        <th style="padding: 10px 20px;">ID</th>
                        <th style="padding: 10px 20px;">Titre de la t√¢che</th>
                        <th style="padding: 10px 20px;">Statut</th>
                        <th style="padding: 10px 20px;">Priorit√©</th>
                        <th style="padding: 10px 20px; text-align: right;">Gouvernance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tasks %}
                        <tr>
                            <td style="color: var(--muted); padding: 15px 20px;">#{{ t.id }}</td>
                            <td style="font-weight: 800; padding: 15px 20px;">{{ t.title }}</td>
                            <td style="padding: 15px 20px;">
                                <span class="badge" style="background: rgba(var(--surface-rgb),0.2); color: var(--text); border: 1px solid var(--border);">{{ t.status|upper }}</span>
                            </td>
                            <td style="padding: 15px 20px;">
                                <span class="badge" style="background: {% if t.priority == 'high' %}rgba(239, 68, 68, 0.15){% else %}rgba(91, 92, 240, 0.15){% endif %}; color: {% if t.priority == 'high' %}#ef4444{% else %}#5b5cf0{% endif %}; border: 1px solid transparent;">
                                    {{ t.priority|upper }}
                                </span>
                            </td>
                            <td style="padding: 15px 20px; text-align: right; border-radius: 0 18px 18px 0;">
                                <form action="{{ path('admin_tasks_delete', {id: t.id}) }}" method="POST" onsubmit="return confirm('Supprimer d√©finitivement cette t√¢che ?');" style="display: inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('admin_delete_task_' ~ t.id) }}">
                                    <button type="submit" class="btn-delete">
                                        <i class="fa-solid fa-trash-can"></i> Supprimer
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--muted); padding: 40px;">Aucune t√¢che enregistr√©e.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- üìâ Data for JS -->
    <script id="chartsData" type="application/json">
        {{ charts|json_encode|raw }}
    </script>

    <!-- üìâ Chart.js Loader -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
    (function() {
        let chartsInstances = [];
        
        function getThemeColor(variable) {
            return getComputedStyle(document.documentElement).getPropertyValue(variable).trim() || '#93a4c7';
        }

        function initCharts() {
            const dataElement = document.getElementById('chartsData');
            if (!dataElement) return;
            
            const data = JSON.parse(dataElement.textContent);
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            const labelColor = getThemeColor('--muted');
            const gridColor = isLight ? 'rgba(0,0,0,0.05)' : 'rgba(255,255,255,0.05)';

            // Clean up old charts
            chartsInstances.forEach(c => c.destroy());
            chartsInstances = [];

            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        grid: { color: gridColor }, 
                        border: { display: false }, 
                        ticks: { color: labelColor, font: { size: 10, weight: 'bold' } } 
                    },
                    x: { 
                        grid: { display: false }, 
                        border: { display: false }, 
                        ticks: { color: labelColor, font: { size: 10, weight: 'bold' } } 
                    }
                }
            };

            // 1. Line Chart
            const ctxLine = document.getElementById('chartMonths');
            if (ctxLine) {
                chartsInstances.push(new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: data.months.labels,
                        datasets: [{
                            label: 'T√¢ches',
                            data: data.months.data,
                            borderColor: '#5b5cf0',
                            backgroundColor: 'rgba(91, 92, 240, 0.15)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointBackgroundColor: '#fff',
                            borderWidth: 3
                        }]
                    },
                    options: baseOptions
                }));
            }

            // 2. Status Chart (Donut)
            const ctxStatus = document.getElementById('chartStatus');
            if (ctxStatus) {
                chartsInstances.push(new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: data.status.labels,
                        datasets: [{
                            data: data.status.data,
                            backgroundColor: ['#f59e0b', '#5b5cf0', '#10b981'],
                            hoverOffset: 15,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        ...baseOptions,
                        plugins: { 
                            legend: { 
                                display: true, 
                                position: 'bottom', 
                                labels: { color: labelColor, boxWidth: 12, padding: 15, font: { size: 11, weight: 'bold' } } 
                            } 
                        },
                        scales: { y: { display: false }, x: { display: false } }
                    }
                }));
            }

            // 3. Priority Chart (Bar)
            const ctxPriority = document.getElementById('chartPriority');
            if (ctxPriority) {
                chartsInstances.push(new Chart(ctxPriority, {
                    type: 'bar',
                    data: {
                        labels: data.priority.labels,
                        datasets: [{
                            data: data.priority.data,
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderRadius: 8,
                            barThickness: 25
                        }]
                    },
                    options: baseOptions
                }));
            }
        }

        // Run when window loads
        window.addEventListener('load', initCharts);
        
        // Watch for theme changes
        const observer = new MutationObserver(() => {
            initCharts();
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        
        // Safety check if already loaded
        if (document.readyState === 'complete') initCharts();

    })();
    </script>
{% endblock %}
