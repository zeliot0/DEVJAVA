{% extends 'theme/base.html.twig' %}

{% block title %}Modifier Objectif{% endblock %}

{% block body %}
<div class="container-fluid mt-4 goals-form-page">
    <div class="d-flex justify-content-between align-items-center mb-4 goals-form-header">
        <div>
            <h1 class="h2 mb-1"><i class="fas fa-pen-to-square me-2"></i>Modifier l'objectif</h1>
            <p class="mb-0">Mettez a jour les informations de votre objectif</p>
        </div>
        <div class="goals-inline-actions">
            <a href="{{ path('app_milestones_index') }}" class="btn btn-outline-secondary goals-btn goals-btn-secondary">
                <i class="fas fa-flag me-1"></i> Jalons
            </a>
            <a href="{{ path('app_goal_index') }}" class="btn btn-outline-secondary goals-btn goals-btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Retour
            </a>
        </div>
    </div>

    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    <div class="card border-0 shadow-sm goals-form-card">
        <div class="card-body">
            {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

            <div class="goals-form-layout">
                <div class="goals-form-main">
                    <section class="goals-section">
                        <h3 class="goals-section-title"><i class="fas fa-pen"></i> Informations principales</h3>
                        <div class="mb-3">
                            {{ form_label(form.titleGoa, 'Titre', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                            {{ form_widget(form.titleGoa, {'attr': {'class': 'form-control'}}) }}
                            <div class="text-danger">{{ form_errors(form.titleGoa) }}</div>
                        </div>

                        <div class="mb-0">
                            {{ form_label(form.descriptionGoa, 'Description', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                            {{ form_widget(form.descriptionGoa, {'attr': {'class': 'form-control', 'rows': 4}}) }}
                            <div class="text-danger">{{ form_errors(form.descriptionGoa) }}</div>
                        </div>
                    </section>

                    <section class="goals-section">
                        <h3 class="goals-section-title"><i class="fas fa-calendar-alt"></i> Planification</h3>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form_label(form.dateDebutGoa, 'Date de début', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                                {{ form_widget(form.dateDebutGoa, {'attr': {'class': 'form-control'}}) }}
                                <div class="text-danger">{{ form_errors(form.dateDebutGoa) }}</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                {{ form_label(form.dateFinalGoa, 'Date de fin', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                                {{ form_widget(form.dateFinalGoa, {'attr': {'class': 'form-control'}}) }}
                                <div class="text-danger">{{ form_errors(form.dateFinalGoa) }}</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form_label(form.statusGoa, 'Statut', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                                {{ form_widget(form.statusGoa, {'attr': {'class': 'form-control'}}) }}
                                <div class="text-danger">{{ form_errors(form.statusGoa) }}</div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <div class="progress-edit-container">
                                    <label class="form-label fw-semibold">Progression</label>

                                    {% set p = form.progressGoa.vars.value ?? 0 %}
                                    {{ form_widget(form.progressGoa, {'attr': {'class': 'd-none', 'id': 'realProgress'}}) }}

                                    <div class="progress-modern">
                                        <button type="button" class="progress-btn down">-</button>
                                        <div class="progress-bar-modern">
                                            <div class="progress-fill-modern" id="progressFill"></div>
                                        </div>
                                        <button type="button" class="progress-btn up">+</button>
                                    </div>

                                    <div class="progress-percent" id="progressText">{{ p }}%</div>
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                {{ form_label(form.priorityGoa, 'Priorité', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                                {{ form_widget(form.priorityGoa, {'attr': {'class': 'form-control'}}) }}
                                <div class="text-danger">{{ form_errors(form.priorityGoa) }}</div>
                            </div>
                        </div>
                    </section>

                    <section class="goals-section">
                        <h3 class="goals-section-title"><i class="fas fa-sliders-h"></i> Détails complémentaires</h3>
                        <div class="mb-3">
                            {{ form_label(form.categoryGoa, 'Catégorie', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                            {{ form_widget(form.categoryGoa, {'attr': {'class': 'form-control'}}) }}
                            <div class="text-danger">{{ form_errors(form.categoryGoa) }}</div>
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.notesGoa, 'Notes', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                            {{ form_widget(form.notesGoa, {'attr': {'class': 'form-control', 'rows': 3}}) }}
                            <div class="text-danger">{{ form_errors(form.notesGoa) }}</div>
                        </div>

                        <div class="mb-0">
                            {{ form_label(form.colorGoa, 'Couleur', {'label_attr': {'class': 'form-label fw-semibold'}}) }}
                            {{ form_widget(form.colorGoa, {'attr': {'class': 'form-control'}}) }}
                            <div class="text-danger">{{ form_errors(form.colorGoa) }}</div>
                        </div>
                    </section>

                    <div class="d-flex gap-2 justify-content-end mt-4 pt-3 border-top goals-form-actions">
                        <a href="{{ path('app_goal_index') }}" class="btn btn-outline-secondary goals-btn goals-btn-secondary">
                            <i class="fas fa-times me-1"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary goals-btn goals-btn-primary">
                            <i class="fas fa-check me-1"></i> Mettre à jour
                        </button>
                    </div>
                </div>

                <aside class="goals-form-aside" aria-label="Aide">
                    <div class="goals-aside-card">
                        <h3><i class="fas fa-lightbulb"></i> Conseils rapides</h3>
                        <ul>
                            <li>Vérifiez les dates avant d'enregistrer.</li>
                            <li>Maintenez la progression réaliste.</li>
                            <li>Utilisez des notes courtes et claires.</li>
                        </ul>
                    </div>
                </aside>
            </div>

            <!-- SUCCESS CELEBRATION -->
            <div id="goalSuccessPopup" class="goal-success-popup">
                <div class="goal-success-card">
                    <div class="goal-success-flag"></div>
                    <h2>Congrats! &#127881;</h2>
                    <p class="lead">You've reached your goal!</p>
                    <p class="goal-message">
                        Do not forget, our goal is to <strong>"Free Palestine"</strong>.
                    </p>
                    <button type="button" class="btn btn-light mt-3" id="closeGoalPopup">
                        Close
                    </button>
                </div>
            </div>

            {{ form_end(form) }}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}

<script>
document.addEventListener("DOMContentLoaded", function () {

    const input = document.querySelector('[name$="[progressGoa]"]');
    const fill = document.getElementById("progressFill");
    const text = document.getElementById("progressText");

    const popup = document.getElementById("goalSuccessPopup");
    const closeBtn = document.getElementById("closeGoalPopup");

    if (!input || !fill || !text) return;

    function color(v) {
        if (v == 100) return "#22c55e";
        if (v > 60) return "#3b82f6";
        if (v > 30) return "#f59e0b";
        return "#ef4444";
    }

    function update(v) {
        v = Math.max(0, Math.min(100, v));
        input.value = v;
        fill.style.width = v + "%";
        fill.style.background = color(v);
        text.innerText = v + "%";

        // Show popup when 100%
        if (v === 100 && popup) {
            popup.classList.add("show");
        }
    }

    // load value from database
    update(parseFloat(input.value || 0));

    document.querySelector(".progress-btn.up").addEventListener("click", () => {
        update(parseFloat(input.value || 0) + 10);
    });

    document.querySelector(".progress-btn.down").addEventListener("click", () => {
        update(parseFloat(input.value || 0) - 10);
    });

    if (closeBtn) {
        closeBtn.addEventListener("click", () => {
            popup.classList.remove("show");
        });
    }

});
</script>

{% endblock %}


