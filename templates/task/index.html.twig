{% extends 'base.html.twig' %}

{% block title %}NEXA - Task Hub{% endblock %}

{% block body %}
{% set currentUserName = app.user and app.user.nom ? app.user.nom|capitalize : 'Utilisateur' %}
{% set currentUserEmail = app.user and app.user.email ? app.user.email : '' %}
{% set currentUserInitial = app.user and app.user.nom ? app.user.nom|first|upper : 'U' %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/nexa-nav.css?v=20260214b">
<link rel="stylesheet" href="/assets/modern-drawers.css">
<link rel="stylesheet" href="/assets/execution-drawer-fix.css">
<link rel="stylesheet" href="/assets/ai-features.css">
<link rel="stylesheet" href="/assets/business-features.css?v=20260210w">
<link rel="stylesheet" href="/assets/dropdown-actions.css?v=20260213k">
<link rel="stylesheet" href="/assets/task-cards-premium.css?v=20260213z">
<link rel="stylesheet" href="{{ asset('css/page-white-bg-overrides.css?v=20260214d') }}">

<div class="layout layout-pro" id="appLayout">
 
  <!-- Premium Navigation System -->
  <div class="backdrop-new" id="backdropNav" aria-hidden="true"></div>
 
  <header class="navbar-custom" id="topbarNav">
    <a href="{{ path('app_landing') }}" class="logo-new">NEXA</a>
 
    <nav class="desktop-nav" aria-label="Main Navigation">
      <div class="nav-pill-new">
        <a href="{{ path('app_task_index') }}" class="active" id="nav_1">TASKS</a>
        <a href="{{ path('app_conscience_index') }}" id="nav_2">CONSCIENCE</a>
        <a href="{{ path('app_goal_index') }}" id="nav_3">GOALS</a>
        <a href="{{ path('app_produit_index') }}" id="nav_4">PRODUIT</a>
      </div>
    </nav>
 
    <div class="header-actions-new">
      <div class="lang-switch-new">
        <button class="lang-btn-new" id="langBtnNav">
          <i class="fa-solid fa-globe"></i>
          <span id="currentLangNav">FR</span>
        </button>
        <div class="lang-menu-new" id="langMenuNav">
          <div data-lang="fr">FR - Francais</div>
          <div data-lang="en">EN - English</div>
          <div data-lang="ar">AR - Arabic</div>
        </div>
      </div>
 
      <button class="icon-btn" id="themeToggleNav"><i class="fa-solid fa-moon"></i></button>
      <button class="icon-btn burger-new" id="menuBtnNav"><i class="fa-solid fa-bars"></i></button>

      <div class="user-menu-nav">
        <button type="button" class="user-quick-nav user-menu-trigger-nav" id="userMenuTriggerNav" aria-expanded="false" aria-controls="userMenuDropdownNav">
          <span class="uq-meta">
            <strong>{{ currentUserName }}</strong>
            <small>Plan Starter</small>
          </span>
          <span class="uq-avatar">{{ currentUserInitial }}</span>
          <i class="fa-solid fa-chevron-down"></i>
        </button>
        <div class="user-menu-dropdown-nav" id="userMenuDropdownNav" hidden>
          <a href="{{ path('app_profile') }}"><i class="fa-regular fa-user"></i> Mon profil</a>
          {% if is_granted('ROLE_ADMIN') %}
            <a href="{{ path('admin_dashboard') }}"><i class="fa-solid fa-shield-halved"></i> Dashboard</a>
          {% endif %}
          <a href="{{ path('app_logout') }}" class="danger"><i class="fa-solid fa-right-from-bracket"></i> Deconnexion</a>
        </div>
      </div>
    </div>
  </header>
 
  <!-- Mobile Navigation Drawer -->
  <aside class="drawer-new" id="drawerNav">
    <div class="drawer-top-new">
      <div class="drawer-title-new" id="drawerTitleNav">NEXA</div>
      <button class="icon-btn" id="closeDrawerNav"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <nav class="drawer-nav-new">
      <a href="{{ path('app_task_index') }}" id="mnav_1">TASKS</a>
      <a href="{{ path('app_conscience_index') }}" id="mnav_2">CONSCIENCE</a>
      <a href="{{ path('app_goal_index') }}" id="mnav_3">GOALS</a>
      <a href="{{ path('app_produit_index') }}" id="mnav_4">PRODUIT</a>
    </nav>
    <a href="{{ path('app_profile') }}" class="drawer-user-card">
      <span class="uq-avatar">{{ currentUserInitial }}</span>
      <span class="uq-meta">
        <strong>{{ currentUserName }}</strong>
        <small>{{ currentUserEmail }}</small>
      </span>
    </a>
  </aside>

  <div class="toast-new" id="toastNav"></div>



  <main class="main main-pro">

    <div class="topbar topbar-pro">
      <div class="top-left">
        <div class="toolbar-block-title">Recherche et filtres</div>
        <div class="toolbar-integrated">
          <div class="field field-pro">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="searchInput" placeholder="Rechercher..." />
            <button id="voiceBtn" class="icon-btn icon-btn-pro" type="button" title="Recherche vocale">
              <i class="fa-solid fa-microphone"></i>
            </button>
          </div>

          <div class="field field-pro">
            <i class="fa-solid fa-flag"></i>
            <select id="prioFilter">
              <option value="all">Priorités</option>
              <option value="low">Basse</option>
              <option value="med">Moyenne</option>
              <option value="high">Haute</option>
            </select>
          </div>

          <div class="field field-pro">
            <i class="fa-solid fa-layer-group"></i>
            <select id="statusFilter">
              <option value="all">Statuts</option>
              <option value="todo">À faire</option>
              <option value="doing">En cours</option>
              <option value="done">Terminé</option>
            </select>
          </div>

          <button class="btn subtle icon-only" id="clearBtn" title="Reset filtres">
            <i class="fa-solid fa-broom"></i>
          </button>
        </div>
      </div>

      <div class="top-right">
        <div class="toolbar-block-title toolbar-block-title-right">Actions rapides</div>
        <div class="top-actions-primary">
          <button class="btn primary" id="newBtn">
            <i class="fa-solid fa-plus"></i> Nouvelle tâche
          </button>
          <button class="btn primary" id="newCatBtn" type="button">
            <i class="fa-solid fa-folder-plus"></i> Nouvelle catégorie
          </button>
        </div>

        <div class="top-actions-secondary">
          <div class="v-divider"></div>

          <div class="actions-dropdown" id="actionsDropdown">
            <button class="btn btn-modern main-actions-btn" id="mainActionsBtn" type="button" title="Actions & Exports">
              <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>

            <div class="actions-menu" id="actionsMenu">
            <button class="btn btn-modern pdf-btn" id="exportPdfBtn" type="button" title="Exporter en PDF">
              <i class="fa-solid fa-file-pdf"></i> Export PDF
            </button>
            <button class="btn btn-modern excel-btn" id="exportExcelBtn" type="button" title="Exporter en Excel">
              <i class="fa-solid fa-file-excel"></i> Excel
            </button>
            <button class="btn btn-modern" id="showTodayBtn" type="button" title="Afficher les tâches du jour">
              <i class="fa-solid fa-calendar-day"></i> Aujourd'hui
            </button>
            <button class="btn btn-modern" id="showOverdueBtn" type="button" title="Afficher les tâches en retard">
              <i class="fa-solid fa-triangle-exclamation"></i> En retard
            </button>
            <button class="btn btn-modern" id="autoPrioritizeBtn" type="button" title="Priorisation automatique">
              <i class="fa-solid fa-wand-magic-sparkles"></i> Auto-prioriser
            </button>
            <button class="btn btn-modern analytics-btn" id="showAnalyticsBtn" type="button" title="Voir les analytics">
              <i class="fa-solid fa-chart-line"></i> Analytics
            </button>
            <button class="btn btn-modern" id="showCalendarBtn" type="button" title="Voir le calendrier des taches">
              <i class="fa-solid fa-calendar-days"></i> Calendrier
            </button>
            <button class="btn btn-modern" id="showWeatherBtn" type="button" title="Voir la météo">
              <i class="fa-solid fa-cloud-sun"></i> Météo
            </button>
            <div class="menu-divider"></div>
            {% if is_granted('ROLE_ADMIN') %}
              <a href="{{ path('admin_dashboard') }}" class="btn btn-modern admin-btn" id="goToAdminBtn" title="Dashboard Admin" style="display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-shield-halved"></i> Admin
              </a>
            {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="content-grid">
      <section class="center">



        <div class="kpis kpis-pro">
          <div class="kpi kpi-pro">
            <div class="kpi-title">Total</div>
            <div class="kpi-value" id="kpiTotal">0</div>
          </div>

          <div class="kpi kpi-pro">
            <div class="kpi-title">En cours</div>
            <div class="kpi-value" id="kpiDoing">0</div>
          </div>

          <div class="kpi kpi-pro">
            <div class="kpi-title">Priorité haute</div>
            <div class="kpi-value" id="kpiHigh">0</div>
          </div>
        </div>

        <div class="board board-pro">
          <div class="col col-pro" data-col="todo">
            <div class="col-header col-header-pro">
              <div class="col-title"><span class="dot todo"></span> À faire</div>
              <div class="col-count" id="countTodo">0</div>
            </div>
            <div class="dropzone" id="zone-todo"></div>
          </div>

          <div class="col col-pro" data-col="doing">
            <div class="col-header col-header-pro">
              <div class="col-title"><span class="dot doing"></span> En cours</div>
              <div class="col-count" id="countDoing">0</div>
            </div>
            <div class="dropzone" id="zone-doing"></div>
          </div>

          <div class="col col-pro" data-col="done">
            <div class="col-header col-header-pro">
              <div class="col-title"><span class="dot done"></span> Terminé</div>
              <div class="col-count" id="countDone">0</div>
            </div>
            <div class="dropzone" id="zone-done"></div>
          </div>
        </div>
      </section>
    </div>

    <!-- DRAWER TASK -->
    <div class="overlay" id="overlay"></div>
    <aside class="drawer drawer-modern" id="drawer">
      <div class="drawer-head drawer-head-modern">
        <div>
          <h3 class="drawer-title drawer-title-modern" id="drawerTitle">Nouvelle tâche</h3>
          <div class="drawer-sub" id="drawerSub">Configurez les détails de votre mission</div>
        </div>
        <button class="icon-btn" id="closeDrawer" title="Fermer"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="drawer-body drawer-body-modern">
        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-circle-info"></i> Informations principales</div>
          <div class="field field-modern">
            <i class="fa-solid fa-heading"></i>
            <input id="fTitle" placeholder="Titre de la tâche" />
            <label>TITRE</label>
          </div>
          <div class="field field-modern" style="margin-top: 15px;">
            <i class="fa-solid fa-align-left"></i>
            <textarea id="fDesc" placeholder="Description détaillée..."></textarea>
            <label>DESCRIPTION</label>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-sliders"></i> Paramètres & Priorité</div>
          <div class="grid2">
            <div class="field field-modern">
              <i class="fa-solid fa-flag"></i>
              <select id="fPrio">
                <option value="low">Basse</option>
                <option value="med" selected>Moyenne</option>
                <option value="high">Haute</option>
              </select>
              <label>PRIORITÉ</label>
            </div>

            <div class="field field-modern">
              <i class="fa-solid fa-layer-group"></i>
              <select id="fStatus">
                <option value="todo">À faire</option>
                <option value="doing">En cours</option>
                <option value="done">Terminé</option>
              </select>
              <label>STATUT</label>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-calendar-days"></i> Organisation</div>
          <div class="grid2">
            <div class="field field-modern">
              <i class="fa-regular fa-calendar"></i>
              <input id="fDue" type="date" />
              <label>ÉCHÉANCE</label>
            </div>

            <div class="field field-modern">
              <i class="fa-solid fa-folder"></i>
              <select id="fCategory">
                <option value="">Aucune catégorie</option>
              </select>
              <label>CATÉGORIE</label>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-wand-magic-sparkles"></i> Assistant IA</div>
          <div class="ai-toolbar" style="padding: 0; margin: 0; border: none;">
            <button class="btn btn-modern ai-btn" id="aiGenerateDesc" type="button" title="Générer une description avec l'IA" style="flex: 1;">
              <i class="fa-solid fa-wand-magic-sparkles"></i> Description IA
            </button>
            
            <button class="btn btn-modern ai-btn" id="aiAnalyzeTask" type="button" title="Analyser la tÃ¢che" style="flex: 1;">
              <i class="fa-solid fa-brain"></i> Analyser
            </button>
          </div>

          <div class="ai-suggestions" id="aiSuggestions">
            <div class="ai-suggestion-title">
              <i class="fa-solid fa-lightbulb"></i> Suggestions de l'IA
            </div>
            <div id="aiSuggestionsContent"></div>
          </div>
        </div>
      </div>

      <div class="drawer-foot drawer-foot-modern">
        <button class="btn btn-modern btn-delete" id="deleteBtn" style="display:none;">
          <i class="fa-solid fa-trash"></i> Supprimer
        </button>

        <button class="btn btn-modern" id="editBtn" style="display:none;">
          <i class="fa-regular fa-pen-to-square"></i> Modifier
        </button>

        <button class="btn btn-modern" id="cancelBtn" style="margin-left: auto;">
          Annuler
        </button>

        <button class="btn primary btn-modern" id="saveBtn">
          <i class="fa-solid fa-check"></i> Enregistrer
        </button>
      </div>
    </aside>

    <!-- DRAWER CATEGORY -->
    <div class="overlay" id="catOverlay"></div>
    <aside class="drawer drawer-modern" id="catDrawer">
      <div class="drawer-head drawer-head-modern">
        <div>
          <h3 class="drawer-title drawer-title-modern">Nouvelle catégorie</h3>
          <div class="drawer-sub">Classez vos projets avec style</div>
        </div>
        <button class="icon-btn" id="closeCatDrawer" title="Fermer" type="button">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="drawer-body drawer-body-modern">
        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-layer-group"></i> Identité</div>
          <div class="field field-modern">
            <i class="fa-solid fa-heading"></i>
            <input id="cat_name" placeholder="Nom de la catégorie *" />
            <label>NOM</label>
          </div>

          <div class="field field-modern" style="margin-top: 15px;">
            <i class="fa-solid fa-align-left"></i>
            <textarea id="cat_description" placeholder="Description courte (optionnel)"></textarea>
            <label>DESCRIPTION</label>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-palette"></i> Apparence & Icône</div>
          <div class="grid2">
            <div class="field field-modern">
              <i class="fa-solid fa-palette"></i>
              <input id="cat_color" type="color" value="#7c3aed" style="height: 38px; padding: 0; cursor: pointer;" />
              <label>COULEUR</label>
            </div>

            <div class="field field-modern">
              <i class="fa-solid fa-icons"></i>
              <input id="cat_icon" placeholder="ex: fa-solid fa-star" />
              <label>ICÔNE (FontAwesome)</label>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title"><i class="fa-solid fa-gear"></i> Paramètres avancés</div>
          <div class="grid2">
            <div class="field field-modern">
              <i class="fa-solid fa-toggle-on"></i>
              <select id="cat_isActive">
                <option value="1" selected>Active</option>
                <option value="0">Inactive</option>
              </select>
              <label>STATUT</label>
            </div>

            <div class="field field-modern">
              <i class="fa-solid fa-eye"></i>
              <select id="cat_visibility">
                <option value="">Par défaut</option>
                <option value="public">Public</option>
                <option value="private">Privé</option>
              </select>
              <label>VISIBILITÉ</label>
            </div>
          </div>

          <div class="grid2" style="margin-top: 15px;">
            <div class="field field-modern">
              <i class="fa-solid fa-arrow-up-1-9"></i>
              <input id="cat_position" type="number" placeholder="0" />
              <label>ORDRE</label>
            </div>

            <div class="field field-modern">
              <i class="fa-solid fa-list-check"></i>
              <input id="cat_taskLimit" type="number" placeholder="8" />
              <label>LIMITE TÂCHES</label>
            </div>
          </div>
        </div>

        <div class="field field-modern">
          <i class="fa-solid fa-hashtag"></i>
          <input id="cat_no" placeholder="Référence (ex: MKT-2024)" />
          <label>IDENTIFIANT UNIQUE</label>
        </div>
      </div>

      <div class="drawer-foot drawer-foot-modern">
        <button class="btn btn-modern" id="cancelCatBtn" type="button" style="margin-left: auto;">
          Annuler
        </button>

        <button class="btn primary btn-modern" id="saveCatBtn" type="button">
          <i class="fa-solid fa-check"></i> Créer la catégorie
        </button>
      </div>
    </aside>

    {# =======================
       DRAWER EXECUTIONS
       ======================= #}
    <div class="overlay" id="exeOverlay"></div>

    <aside class="drawer drawer-modern" id="exeDrawer" aria-hidden="true">
      <div class="drawer-head drawer-head-modern">
        <div>
          <h3 class="drawer-title drawer-title-modern">
            <i class="fa-solid fa-terminal"></i> Journal d’exécution
          </h3>
          <div class="drawer-sub">
            Suivi en temps réel de: <b id="exeTaskTitle" style="color: var(--primary)">—</b>
          </div>
        </div>

        <button class="icon-btn" id="closeExeDrawer" title="Fermer">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="drawer-body drawer-body-modern">

        <div class="kpis kpis-pro" style="margin: 0; background: rgba(var(--surface-rgb), 0.3); border-radius: 20px; padding: 10px;">
          <div class="kpi kpi-pro" style="background: transparent; border: none; box-shadow: none; min-width: auto; padding: 10px;">
            <div class="kpi-title" style="font-size: 0.7rem;">Total</div>
            <div class="kpi-value" id="exeKpiTotal" style="font-size: 1.2rem;">0</div>
          </div>
          <div class="kpi kpi-pro" style="background: transparent; border: none; box-shadow: none; min-width: auto; padding: 10px;">
            <div class="kpi-title" style="font-size: 0.7rem;">Doing</div>
            <div class="kpi-value" id="exeKpiDoing" style="font-size: 1.2rem; color: var(--primary)">0</div>
          </div>
          <div class="kpi kpi-pro" style="background: transparent; border: none; box-shadow: none; min-width: auto; padding: 10px;">
            <div class="kpi-title" style="font-size: 0.7rem;">Done</div>
            <div class="kpi-value" id="exeKpiDone" style="font-size: 1.2rem; color: var(--good)">0</div>
          </div>
        </div>

        <div class="toolbar toolbar-pro" style="margin: 0; grid-template-columns: 1fr 120px;">
          <div class="field field-modern" style="padding: 10px 14px !important;">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="exeSearch" placeholder="Filtrer..." />
          </div>

          <div class="field field-modern" style="padding: 10px 14px !important;">
            <select id="exeStatusFilter">
              <option value="all">Tous</option>
              <option value="todo">À faire</option>
              <option value="doing">En cours</option>
              <option value="done">Terminé</option>
            </select>
          </div>
        </div>

        <div id="exeCreateCard" class="exe-card-modern">
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:18px;">
            <div style="font-weight:800; font-size: 1.1rem; color: var(--text);">
               <i class="fa-solid fa-plus-circle" style="color: var(--primary); margin-right: 8px;"></i>Nouvelle étape
            </div>
          </div>

          <div class="field field-modern">
            <i class="fa-solid fa-heading"></i>
            <input id="exeTitle" placeholder="Titre de l'action" />
            <label>TITRE</label>
          </div>

          <div class="field field-modern" style="margin-top: 15px;">
            <i class="fa-solid fa-align-left"></i>
            <textarea id="exeDesc" placeholder="Note ou rÃ©sultat..." style="min-height: 60px;"></textarea>
            <label>DESCRIPTION</label>
          </div>

          <div style="margin-top: 15px; display: flex; flex-direction: column; gap: 15px;">
            <div class="field field-modern">
              <i class="fa-solid fa-layer-group"></i>
              <select id="exeStatus">
                <option value="todo">À faire</option>
                <option value="doing">En cours</option>
                <option value="done">Terminé</option>
              </select>
              <label>STATUT</label>
            </div>

            <button class="btn primary btn-modern" id="exeSaveBtn" type="button" style="width: 100%; justify-content: center; padding: 14px 20px !important;">
              <i class="fa-solid fa-plus"></i> Ajouter l execution
            </button>
          </div>

          <input type="hidden" id="exeEditId" value="">
        </div>

        <div id="exeList" style="display:flex;flex-direction:column;gap:12px;"></div>
      </div>

      <div class="drawer-foot drawer-foot-modern">
        <button class="btn btn-modern" id="exeCloseBtn" type="button" style="width: 100%; justify-content: center;">
          <i class="fa-regular fa-circle-xmark"></i> Quitter le journal
        </button>
      </div>
    </aside>

    <style>
      .exe-item {
        padding: 16px;
        border-radius: 20px;
        border: 1px solid rgba(var(--primary-rgb, 91, 92, 240), 0.1);
        background: rgba(var(--surface-rgb), 0.4);
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        margin-bottom: 8px;
        backdrop-filter: blur(8px);
      }
      .exe-item:hover {
        background: rgba(var(--surface-rgb), 0.6);
        border-color: rgba(var(--primary-rgb, 91, 92, 240), 0.3);
        transform: translateX(4px);
      }
      .exe-left { 
        display: flex; 
        gap: 14px; 
        align-items: center; 
        flex: 1;
        min-width: 0;
      }
      .exe-status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .exe-status-dot.todo { background: #94a3b8; box-shadow: 0 0 10px rgba(148, 163, 184, 0.3); }
      .exe-status-dot.doing { background: var(--primary); box-shadow: 0 0 10px rgba(91, 92, 240, 0.4); }
      .exe-status-dot.done { background: var(--good); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }

      .exe-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }
      .exe-title-text {
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .exe-desc-text {
        font-size: 0.85rem;
        color: var(--muted);
        line-height: 1.4;
      }
      
      .exe-badge {
        font-size: 0.7rem;
        padding: 4px 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--muted);
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .exe-actions { display: flex; gap: 8px; }
      .mini-btn {
        border-radius: 10px;
        width: 32px;
        height: 32px;
        display: grid;
        place-items: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
        color: var(--muted);
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .mini-btn:hover { 
        background: rgba(var(--primary-rgb, 91, 92, 240), 0.1);
        color: var(--primary);
        border-color: var(--primary);
        transform: scale(1.1);
      }
      .mini-btn.danger:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--bad);
        border-color: var(--bad);
      }


      /* Professional toolbar organization */
      .topbar-pro {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(360px, 390px);
        gap: 10px;
        align-items: start;
        padding: 9px;
        border: 1px solid rgba(148, 163, 184, 0.26);
        border-radius: 14px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.94), rgba(249, 250, 255, 0.9));
        box-shadow: 0 8px 18px rgba(30, 41, 59, 0.08);
        overflow: visible;
      }

      .top-left,
      .top-right {
        min-width: 0;
      }

      .toolbar-block-title {
        font-size: 0.68rem;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #5f6b85;
        margin: 0 0 6px 2px;
      }

      .toolbar-block-title-right {
        text-align: right;
        margin-right: 2px;
      }

      .toolbar-integrated {
        display: grid;
        grid-template-columns: minmax(190px, 1fr) minmax(110px, 140px) minmax(110px, 140px) 38px;
        gap: 8px;
        align-items: center;
      }

      .toolbar-integrated > * {
        min-width: 0;
      }

      .toolbar-integrated .field.field-pro {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        min-height: 40px;
        border-radius: 12px;
        border: 1px solid #dbe2f2;
        background: #fff;
        box-shadow: 0 3px 8px rgba(30, 41, 59, 0.05);
        overflow: hidden;
      }

      .toolbar-integrated .field.field-pro select,
      .toolbar-integrated .field.field-pro input {
        width: 100%;
        min-width: 0;
      }

      .toolbar-integrated #clearBtn {
        width: 38px;
        height: 38px;
        border-radius: 11px;
      }

      .top-right {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        justify-items: end;
        align-content: start;
      }

      .top-actions-primary,
      .top-actions-secondary {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
      }

      .top-actions-secondary {
        padding-left: 2px;
      }

      .top-actions-secondary .actions-dropdown {
        display: flex;
        align-items: center;
      }

      .topbar-pro .top-right #newBtn,
      .topbar-pro .top-right #newCatBtn {
        width: 170px;
        height: 40px;
        min-height: 40px;
        min-width: 150px;
        max-width: 170px;
        padding: 0 14px;
        border-radius: 12px;
        font-size: 0.88rem;
        font-weight: 700;
        line-height: 1;
        white-space: nowrap;
        box-sizing: border-box;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .topbar-pro .top-right #newBtn,
      .topbar-pro .top-right #newCatBtn {
        border: 1px solid transparent;
        color: #fff;
        background: linear-gradient(135deg, #5b5cf0 0%, #7c3aed 100%);
        box-shadow: 0 8px 18px rgba(91, 92, 240, 0.2);
      }

      .topbar-pro .top-right #newCatBtn i {
        color: #ffffff;
      }

      @media (max-width: 760px) {
        .topbar-pro {
          grid-template-columns: 1fr;
          padding: 10px;
        }

        .toolbar-block-title-right {
          text-align: left;
        }

        .topbar-pro .top-right {
          width: 100%;
          justify-content: stretch;
        }

        .top-actions-primary,
        .top-actions-secondary {
          width: 100%;
        }

        .topbar-pro .top-right #newBtn,
        .topbar-pro .top-right #newCatBtn {
          width: 100%;
          min-width: 0;
          max-width: none;
        }

        .top-actions-secondary {
          justify-content: flex-end;
        }

        .top-actions-secondary .v-divider {
          display: none;
        }
      }

      @media (max-width: 1180px) {
        .topbar-pro {
          grid-template-columns: 1fr;
        }

        .toolbar-block-title-right {
          text-align: left;
        }

        .toolbar-integrated {
          grid-template-columns: minmax(220px, 1fr) minmax(140px, 0.8fr) minmax(140px, 0.8fr) 48px;
        }

        .top-right {
          justify-items: stretch;
        }

        .top-actions-primary {
          width: 100%;
          justify-content: space-between;
        }

        .top-actions-secondary {
          width: 100%;
          justify-content: flex-end;
        }

        .topbar-pro .top-right #newBtn,
        .topbar-pro .top-right #newCatBtn {
          width: calc(50% - 6px);
          min-width: 0;
          max-width: none;
        }
      }

      @media (max-width: 900px) {
        .toolbar-integrated {
          grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 44px;
        }

        .toolbar-integrated .field.field-pro:first-child {
          grid-column: 1 / -1;
        }

        .toolbar-integrated #clearBtn {
          width: 44px;
          height: 44px;
        }
      }

      @media (max-width: 640px) {
        .toolbar-integrated {
          grid-template-columns: minmax(0, 1fr) 44px;
          align-items: center;
        }

        .toolbar-integrated .field.field-pro:first-child {
          grid-column: 1 / -1;
        }

        .toolbar-integrated .field.field-pro:nth-child(2) {
          grid-column: 1 / 2;
        }

        .toolbar-integrated .field.field-pro:nth-child(3) {
          grid-column: 1 / 2;
          grid-row: 3;
        }

        .toolbar-integrated #clearBtn {
          grid-column: 2 / 3;
          grid-row: 3;
          justify-self: end;
        }
      }

      .btn-group-modern {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px;
        background: rgba(var(--surface-rgb), 0.3);
        border-radius: 14px;
        border: 1px solid var(--border);
      }

      .v-divider {
        width: 1px;
        height: 22px;
        background: rgba(255, 255, 255, 0.15);
        margin: 0 2px;
      }

      .excel-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: #fff !important;
        border: none !important;
      }

      .analytics-btn {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        color: #fff !important;
        border: none !important;
      }

      .admin-btn {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%) !important;
        color: #fff !important;
        border: none !important;
        text-decoration: none;
      }

      .btn-modern:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
      }

      .pdf-btn {
        background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%) !important;
        color: #fff !important;
        border: none !important;
      }

      /* Inline validation errors under each field */
      .drawer-modern .field.field-modern {
        position: relative;
      }

      .drawer-modern .field.field-modern.has-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.14);
        margin-bottom: 24px;
      }

      .drawer-modern .field.field-modern.has-error::after {
        content: attr(data-error);
        position: absolute;
        left: 8px;
        top: calc(100% + 6px);
        color: #dc2626;
        font-size: 0.82rem;
        font-weight: 700;
        line-height: 1.3;
        white-space: normal;
        z-index: 2;
      }

      /* Task drawer form visual polish (without changing drawer structure) */
      #drawer .drawer-head-modern {
        background: linear-gradient(135deg, #5b5cf0 0%, #7c3aed 100%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.22);
      }

      #drawer .drawer-title-modern {
        background: none !important;
        -webkit-background-clip: border-box !important;
        background-clip: border-box !important;
        -webkit-text-fill-color: #ffffff !important;
        color: #ffffff !important;
        letter-spacing: -0.02em;
      }

      #drawer .drawer-sub {
        color: rgba(255, 255, 255, 0.9) !important;
        font-weight: 600;
      }

      #drawer .form-section {
        border: 1px solid #dbe3f5;
        border-radius: 18px;
        background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%);
        padding: 16px;
        box-shadow: 0 8px 18px rgba(30, 41, 59, 0.07);
      }

      #drawer .form-section-title {
        margin-bottom: 12px;
        font-size: 0.76rem;
        letter-spacing: 0.11em;
        color: #66728c;
      }

      #drawer .field.field-modern {
        background: #ffffff !important;
        border: 1px solid #d8e1f2 !important;
        border-radius: 14px !important;
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.06);
      }

      #drawer .field.field-modern i {
        color: #6366f1;
        opacity: 0.95;
      }

      #drawer .field.field-modern input,
      #drawer .field.field-modern select,
      #drawer .field.field-modern textarea {
        color: #1f2a44 !important;
      }

      #drawer .field.field-modern input::placeholder,
      #drawer .field.field-modern textarea::placeholder {
        color: #8a97af;
      }

      #drawer .field.field-modern textarea {
        min-height: 84px;
      }

      #drawer .field.field-modern label {
        opacity: 0.9;
        top: -11px;
        transform: none;
        background: #f8faff;
        border: 1px solid #d8e1f2;
        color: #5b5cf0;
      }

      #drawer .field.field-modern:focus-within {
        border-color: #7c3aed !important;
        box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.14), 0 8px 16px rgba(30, 41, 59, 0.08) !important;
        transform: none;
      }

      #drawer .grid2 {
        gap: 12px;
      }

      #drawer .drawer-foot-modern {
        background: #f9fbff !important;
        border-top: 1px solid #dce5f6 !important;
      }

      #drawer .drawer-foot-modern .btn {
        min-height: 44px;
        border-radius: 12px !important;
      }
    </style>

    <div id="toastHost" class="toast-host" aria-live="polite" aria-atomic="true"></div>

    <style>
      #voiceBtn.listening {
        background: rgba(255, 0, 0, .08);
        border: 1px solid rgba(255, 0, 0, .35);
      }
      .toast-host {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 999999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      .toast{
        pointer-events: auto;
        min-width: 280px;
        max-width: 460px;
        padding: 12px 14px;
        border-radius: 14px;
        background: rgba(20, 20, 24, .92);
        color: #fff;
        border: 1px solid rgba(255,255,255,.10);
        box-shadow: 0 18px 45px rgba(0,0,0,.35);
        backdrop-filter: blur(10px);
        display: grid;
        grid-template-columns: 18px 1fr 24px;
        gap: 10px;
        align-items: start;
      }
    </style>

    <script>
      window.NEXA_API = {
        list: "{{ path('api_tasks_list') }}",
        create: "{{ path('api_tasks_create') }}",
        updateBase: "/api/tasks",
        deleteBase: "/api/tasks",
        today: "/api/tasks/today",
        overdue: "/api/tasks/overdue",
        autoPrioritize: "/api/tasks/auto-prioritize",
        batchStatus: "/api/tasks/batch/status",
        batchDelete: "/api/tasks/batch/delete",

        /* ? FIX route problem: hardcode endpoints */
        categories: "/api/categories",
        categoriesCreate: "/api/categories",
        categoriesUpdateBase: "/api/categories",
        categoriesDeleteBase: "/api/categories",

        /* ? EXECUTIONS */
        exeList: "/api/executions",
        exeCreate: "/api/executions",
        exeUpdateBase: "/api/executions",
        exeDeleteBase: "/api/executions",

        /* ? AI */
        aiDescription: "/api/ai/description",
        aiAnalyze: "/api/ai/analyze",
        aiSubtasks: "/api/ai/subtasks",
        aiSummary: "/api/ai/executions-summary",
        aiEstimate: "/api/ai/estimate",
        aiRiskScore: "/api/ai/risk-score",

        /* ? Analytics */
        analyticsThroughput: "/api/analytics/throughput",
        analyticsWorkload: "/api/analytics/workload",
        analyticsCycleTime: "/api/analytics/cycle-time",

        /* ? Jobs */
        jobsCreate: "/api/jobs",
        jobsBase: "/api/jobs",

        /* ? Dashboard */
        dashboardStats: "/api/dashboard/stats",

        /* ? Calendar & Weather */
        calendarEvents: "/api/calendar/events",
        weatherCurrent: "/api/weather/current"
      };
    </script>

    <script src="/assets/board.js?v=20260213c"></script>

    {# âœ… Vue for the eye button #}
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    {# âœ… executions drawer logic (no injection) #}
    <script src="/assets/executions.js"></script>

    <script src="/assets/nexa-nav.js?v=20260213a"></script>
    <script src="/assets/ai-features.js?v=20260209a"></script>
    <script src="/assets/pdf-export-advanced.js?v=20260209a"></script>
    <script src="/assets/business-features.js?v=20260210w"></script>
    <script src="/assets/ai-integration.js?v=20260209a"></script>
    <script src="/assets/business-integration.js?v=20260210w"></script>

    <script>
      // Actions Dropdown Logic
      const mainActionsBtn = document.getElementById('mainActionsBtn');
      const actionsMenu = document.getElementById('actionsMenu');
      const actionsDropdown = document.getElementById('actionsDropdown');

      if (mainActionsBtn && actionsMenu) {
        mainActionsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          actionsMenu.classList.toggle('active');
          mainActionsBtn.classList.toggle('active');
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
          if (!actionsDropdown.contains(e.target)) {
            actionsMenu.classList.remove('active');
            mainActionsBtn.classList.remove('active');
          }
        });

        // Close after clicking an action (optional, but good UX)
        actionsMenu.querySelectorAll('.btn-modern').forEach(btn => {
          btn.addEventListener('click', () => {
            actionsMenu.classList.remove('active');
            mainActionsBtn.classList.remove('active');
          });
        });
      }
    </script>

    <!-- AI Thinking Indicator -->
    <div class="ai-thinking" id="aiThinkingIndicator">
      <div class="ai-spinner"></div>
      <div class="ai-thinking-text">L'IA travaille pour vous...</div>
    </div>

    <!-- Analytics Modal -->
    <div class="analytics-modal" id="analyticsModal">
      <div class="analytics-content">
        <div class="analytics-header">
          <h2><i class="fa-solid fa-chart-line"></i> Analytics & Rapports</h2>
          <button class="analytics-close" id="closeAnalytics">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="analytics-body" id="analyticsBody">
          <!-- Content will be dynamically generated -->
        </div>
      </div>
    </div>

    <script src="/assets/executions-consult-vue.js"></script>

  </main>
</div>
{% endblock %}
























